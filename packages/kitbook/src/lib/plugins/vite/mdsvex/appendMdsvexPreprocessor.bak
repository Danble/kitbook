import { mdsvex, type MdsvexOptions } from 'mdsvex';
import mdsvexConfig from './mdsvex.config.js';

export function appendMdsvexPreprocessor(preprocessors: any, mdsvexConfig: MdsvexOptions) {
  if (!preprocessors) {
    return [mdsvex(mdsvexConfig)];
  } else if (Array.isArray(preprocessors)) {
    return [mdsvex(mdsvexConfig), ...preprocessors];
    // return [...preprocessors, mdsvex(mdsvexConfig)];
  } else {
    return [mdsvex(mdsvexConfig), preprocessors];
    // return [preprocessors, mdsvex(mdsvexConfig)];
  }
}

if (import.meta.vitest) {
  describe('appendMdsvexPreprocessor', () => {
  test('handles no prior existing preprocessors', () => {
    expect(appendMdsvexPreprocessor(undefined, mdsvexConfig)).toMatchInlineSnapshot(`
      [
        {
          "markup": [Function],
        },
      ]
    `);
  });

  const otherPreprocessor = () => { return { script: () => { } }; };

  test('handles a prior array of preprocessors', () => {
    expect(appendMdsvexPreprocessor([otherPreprocessor(), otherPreprocessor()], mdsvexConfig)).toMatchInlineSnapshot(`
      [
        {
          "script": [Function],
        },
        {
          "script": [Function],
        },
        {
          "markup": [Function],
        },
      ]
    `);
  });

  test('handles a single preprocessor (not in array)', () => {
    expect(appendMdsvexPreprocessor(otherPreprocessor(), mdsvexConfig)).toMatchInlineSnapshot(`
      [
        {
          "script": [Function],
        },
        {
          "markup": [Function],
        },
      ]
    `);
  });
});
}
